<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kiosk</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .screen { position:fixed; inset:0; display:none; }
    .screen.active { display:block; }

    /* 待機：MP4動画 */
    #idleVideoWrap { width:100%; height:100%; }
    #idleVideo { width:100%; height:100%; object-fit:cover; background:#000; }

    /* Googleスライド */
    iframe { width:100%; height:100%; border:0; background:#000; }

    .hint {
      position:fixed; left:0; right:0; bottom:24px;
      text-align:center; color:rgba(255,255,255,.85);
      font: 20px/1.3 system-ui, -apple-system, "Segoe UI", sans-serif;
      pointer-events:none;
      text-shadow:0 2px 8px rgba(0,0,0,.6);
    }
  </style>
</head>
<body>

  <!-- 待機：MP4動画ループ（最初は無音） -->
  <div id="idle" class="screen active">
    <div id="idleVideoWrap">
      <video
        id="idleVideo"
        src="./main.mp4"
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      ></video>
    </div>
    <div class="hint">①タップで音ON　②もう一度タップで開始</div>
  </div>

  <!-- 探索：Googleスライド（スライド1から） -->
  <div id="explore" class="screen">
    <iframe id="slides" allowfullscreen></iframe>
  </div>

  <script>
    // ★GoogleスライドID（d/XXXXX の XXXXX）
    const SLIDE_ID = "1XTp8s8WNJa6qFl9K2akNzSv43JRHN-pQ";

    // 放置で戻るまでの時間（ミリ秒） 60秒 = 60000
    const IDLE_TIMEOUT_MS = 60000;

    const idleScreen = document.getElementById("idle");
    const exploreScreen = document.getElementById("explore");
    const slidesFrame = document.getElementById("slides");
    const idleVideo = document.getElementById("idleVideo");

    let timer = null;

    // 0: 無音待機中 → 1: 音あり待機中 → 2: 探索中
    let tapStage = 0;

    function slideEmbedUrl() {
      return `https://docs.google.com/presentation/d/${SLIDE_ID}/embed?rm=minimal&start=false`;
    }

    function showIdle() {
      exploreScreen.classList.remove("active");
      idleScreen.classList.add("active");

      // スライドを止める
      slidesFrame.src = "about:blank";

      // 待機動画を再開（ここでは「音ありのまま」にしておくと展示が楽）
      // もし「待機に戻ったら毎回無音」にしたいなら下の2行を有効化してね
      // tapStage = 0;
      // idleVideo.muted = true;

      idleVideo.currentTime = 0;
      idleVideo.play().catch(() => {});

      clearTimeout(timer);
      timer = null;
    }

    function showExplore() {
      idleScreen.classList.remove("active");
      exploreScreen.classList.add("active");

      // 探索に入ったら待機動画は止める（音が残らないように）
      idleVideo.pause();

      slidesFrame.src = slideEmbedUrl();
      resetIdleTimer();
    }

    function resetIdleTimer() {
      clearTimeout(timer);
      timer = setTimeout(() => {
        tapStage = 0;
        idleVideo.muted = true;
        showIdle();
      }, IDLE_TIMEOUT_MS);
    }

    // タップ挙動：
    // 待機画面 1回目：音ON
    // 待機画面 2回目：探索へ
    // 探索中：操作があったらタイマー延長
    document.addEventListener("pointerdown", () => {
      if (idleScreen.classList.contains("active")) {
        if (tapStage === 0) {
          tapStage = 1;
          idleVideo.muted = false;
          idleVideo.play().catch(() => {});
          return;
        }
        if (tapStage === 1) {
          tapStage = 2;
          showExplore();
          return;
        }
      } else {
        resetIdleTimer();
      }
    });

    // 探索中の操作は全部“操作あり”扱いにしてタイマー延長
    ["pointermove","keydown","wheel","touchstart","mousemove"].forEach(ev => {
      document.addEventListener(ev, () => {
        if (exploreScreen.classList.contains("active")) resetIdleTimer();
      }, { passive:true });
    });

    // 起動直後は待機
    showIdle();
  </script>
</body>
</html>
